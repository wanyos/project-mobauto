// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}


// ─────────────────────────────────────────────
// USUARIOS
// ─────────────────────────────────────────────
// Tabla principal de usuarios: clientes, mecanicos y admins
model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  role         Role     @default(CUSTOMER)
  firstName    String   @map("first_name")
  lastName     String   @map("last_name")
  phone        String?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relaciones
  vehicles     Vehicle[]
  appointments Appointment[]
  blogPosts    BlogPost[]     // Posts escritos (solo ADMIN)
  blogComments BlogComment[]

  @@map("users")
}

enum Role {
  CUSTOMER
  MECHANIC
  ADMIN
}

// ─────────────────────────────────────────────
// VEHICULOS
// ─────────────────────────────────────────────
// Cada cliente puede tener varios vehiculos registrados
model Vehicle {
  id        String   @id @default(uuid())
  brand     String                          // Marca: Toyota, Seat, VW...
  model     String                          // Modelo: Corolla, Leon, Golf...
  year      Int                             // Ano: 2020
  plate     String   @unique                // Matricula: 1234 ABC
  color     String?                         // Color (opcional)
  ownerId   String   @map("owner_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relaciones
  owner        User          @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  appointments Appointment[]

  @@map("vehicles")
}

// ─────────────────────────────────────────────
// SERVICIOS
// ─────────────────────────────────────────────
// Catalogo de servicios que ofrece el taller
model Service {
  id               String          @id @default(uuid())
  slug             String          @unique          // URL amigable: "chapa-pintura"
  name             String                           // "Chapa y Pintura"
  shortDescription String          @map("short_description")
  fullDescription  String          @map("full_description")
  icon             String                           // Icono Material Icons
  category         ServiceCategory
  estimatedMinutes Int?            @map("estimated_minutes") // Duracion en minutos
  priceMin         Decimal?        @map("price_min") @db.Decimal(10, 2)
  priceMax         Decimal?        @map("price_max") @db.Decimal(10, 2)
  priceLabel       String?         @map("price_label") // "Desde 49€" o "Presupuesto sin compromiso"
  features         String[]                          // Lista de caracteristicas
  isActive         Boolean         @default(true) @map("is_active")
  sortOrder        Int             @default(0) @map("sort_order")
  createdAt        DateTime        @default(now()) @map("created_at")

  // Relaciones
  appointments AppointmentService[]
  faqs         ServiceFaq[]

  @@map("services")
}

enum ServiceCategory {
  BODYWORK     // Chapa y pintura
  REPAIR       // Reparacion
  MAINTENANCE  // Mantenimiento
  INSPECTION   // Pre-ITV, revisiones
  OTHER        // Peritaje, etc.
}

// Preguntas frecuentes de cada servicio
model ServiceFaq {
  id        String @id @default(uuid())
  serviceId String @map("service_id")
  question  String
  answer    String
  sortOrder Int    @default(0) @map("sort_order")

  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@map("service_faqs")
}

// ─────────────────────────────────────────────
// CITAS
// ─────────────────────────────────────────────
// Citas reservadas por los clientes
model Appointment {
  id            String            @id @default(uuid())
  userId        String?           @map("user_id")       // null si reserva sin cuenta
  vehicleId     String?           @map("vehicle_id")    // null si no tiene vehiculo registrado
  scheduledDate DateTime          @map("scheduled_date") @db.Date
  scheduledTime String            @map("scheduled_time") // "10:00"
  duration      Int               @default(60)           // minutos
  status        AppointmentStatus @default(PENDING)
  notes         String?

  // Datos de contacto (por si reserva sin cuenta)
  customerName  String  @map("customer_name")
  customerEmail String  @map("customer_email")
  customerPhone String? @map("customer_phone")

  // Datos del vehiculo (por si no tiene vehiculo registrado)
  vehicleBrand String? @map("vehicle_brand")
  vehicleModel String? @map("vehicle_model")
  vehicleYear  Int?    @map("vehicle_year")
  vehiclePlate String? @map("vehicle_plate")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones
  user     User?              @relation(fields: [userId], references: [id])
  vehicle  Vehicle?           @relation(fields: [vehicleId], references: [id])
  services AppointmentService[]

  @@map("appointments")
}

enum AppointmentStatus {
  PENDING      // Pendiente de confirmacion
  CONFIRMED    // Confirmada por el taller
  IN_PROGRESS  // En proceso de reparacion
  COMPLETED    // Finalizada
  CANCELLED    // Cancelada
}

// Tabla intermedia: una cita puede tener varios servicios
model AppointmentService {
  appointmentId String @map("appointment_id")
  serviceId     String @map("service_id")

  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  service     Service     @relation(fields: [serviceId], references: [id])

  @@id([appointmentId, serviceId])
  @@map("appointment_services")
}

// ─────────────────────────────────────────────
// BLOG
// ─────────────────────────────────────────────
// Articulos del blog (escritos por ADMIN)
model BlogPost {
  id          String        @id @default(uuid())
  slug        String        @unique                 // URL: "como-cuidar-pintura-coche"
  title       String
  excerpt     String                                // Resumen corto para la lista
  content     String                                // Contenido completo (Markdown o HTML)
  coverImage  String?       @map("cover_image")     // URL de la imagen de portada
  authorId    String        @map("author_id")
  category    BlogCategory
  tags        String[]                              // ["pintura", "consejos", "mantenimiento"]
  isPublished Boolean       @default(false) @map("is_published")
  publishedAt DateTime?     @map("published_at")
  views       Int           @default(0)
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  // Relaciones
  author   User          @relation(fields: [authorId], references: [id])
  comments BlogComment[]

  @@map("blog_posts")
}

enum BlogCategory {
  TIPS         // Consejos de mantenimiento
  NEWS         // Noticias del taller
  GUIDES       // Guias paso a paso
  CASE_STUDY   // Casos reales / antes-despues
}

// Comentarios en los posts del blog
model BlogComment {
  id        String   @id @default(uuid())
  postId    String   @map("post_id")
  userId    String   @map("user_id")
  content   String
  createdAt DateTime @default(now()) @map("created_at")

  // Relaciones
  post BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User     @relation(fields: [userId], references: [id])

  @@map("blog_comments")
}

// ─────────────────────────────────────────────
// MENSAJES DE CONTACTO
// ─────────────────────────────────────────────
// Mensajes enviados desde el formulario de contacto
model ContactMessage {
  id        String   @id @default(uuid())
  name      String
  email     String
  phone     String?
  message   String
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("contact_messages")
}

// ─────────────────────────────────────────────
// CONFIGURACION DEL NEGOCIO
// ─────────────────────────────────────────────
// Horarios, dias festivos, configuracion general
model BusinessConfig {
  id    String @id @default(uuid())
  key   String @unique                // "morning_open", "afternoon_close", etc.
  value String                        // "08:00", "19:00", etc.

  @@map("business_config")
}